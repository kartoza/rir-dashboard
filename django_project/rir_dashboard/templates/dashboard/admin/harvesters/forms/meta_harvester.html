{% extends 'dashboard/admin/harvesters/forms/_base_attribute.html' %}
{% load static %}
{% block extrastyle %}
    <style>
        select {
            height: 42px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            margin-top: 0 !important;
            margin-left: 0 !important;
        }
    </style>
{% endblock %}
{% block extrascripts %}
    <script type="text/javascript" src="{% static 'libs/xlsx/0.17.5/jszip.js' %}"></script>
    <script type="text/javascript" src="{% static 'libs/xlsx/0.17.5/xlsx.js' %}"></script>
    <link rel="stylesheet" href="{% static 'libs/select2/4.1.0-rc.0/select2.min.css' %}" type="text/css" media="screen, projection"/>
    <script type="text/javascript" src="{% static 'libs/select2/4.1.0-rc.0/select2.min.js' %}"></script>
    <script>
        $('#attribute_file').prop('disabled', true);
        $(document).ready(function () {
            $('.date').datepicker({ dateFormat: 'yy-mm-dd' });
            const $submit = $('#submit');

            let $selectInput = $('#attribute_column_name_administration_code, #attribute_column_name_indicator, #attribute_column_name_value, #attribute_column_name_date, #attribute_extra_columns');
            $selectInput.each(function () {
                const multiple = $(this).attr('id') === 'attribute_extra_columns' ? 'multiple="multiple"' : ''
                $(this).replaceWith(`<select name="${$(this).attr('name')}" id="${$(this).attr('id')}" disabled="" ${multiple} ${$(this).attr('required')}></select>`)
            })
            $selectInput = $('#attribute_column_name_administration_code, #attribute_column_name_indicator, #attribute_column_name_value, #attribute_column_name_date, #attribute_extra_columns');
            $selectInput.prop('disabled', true);
            $submit.prop('disabled', true);

            $('#attribute_file').prop('disabled', false);
            $('#attribute_file').change(function () {
                var file = this.files[0];
                var fr = new FileReader();
                $submit.prop('disabled', true);
                $selectInput.prop('disabled', true);
                $selectInput.html('');
                fr.onload = function () {
                    var workbook = XLSX.read(fr.result, {
                        type: 'binary'
                    });
                    var array = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {
                        header: 1,
                        defval: '',
                        blankrows: true
                    });

                    $submit.prop('disabled', false);
                    $selectInput.prop('disabled', false);
                    $selectInput.html('')

                    $selectInput.not("#attribute_extra_columns").append(`<option value="">-------- select ---------</option`);
                    $.each(array[0], function (idx, value) {
                        $selectInput.append(`<option value="${value}">${value}</option`);
                    });
                    $('#attribute_extra_columns').select2();
                };
                fr.readAsBinaryString(file);
            })
        });
    </script>
{% endblock extrascripts %}