{% extends 'dashboard/_base.html' %}
{% load static %}
{% load indicator_tags %}

{% block stylesheet %}
    <link href="{% static 'libs/leaflet/1.5.1/leaflet.css' %}" rel="stylesheet" type="text/css" media="screen, projection"/>
    <link href="{% static 'css/dashboard/context-analysis.css' %}" rel="stylesheet" type="text/css" media="screen, projection"/>
    <style>
        {% for scenario in scenarios %}
            .scenario-{{ scenario.level }} {
                background-color: {{ scenario.background_color }} !important;
                color: {{ scenario.text_color}} !important;
            }
        {% endfor %}
    </style>
{% endblock %}
{% block content %}
    <div id="dashboard">
        <div data-program="context-analysis" class="table-section scenario-section">
            <div class="section box-shadow-bottom ">
                <div class="scenario-header scenario-{{ overall_scenario.level }}">
                    <div>Overall Scenario</div>
                    <div>
                        Scenario {% if overall_scenario.level %}{{ overall_scenario.level }}: {{ overall_scenario.name }}{% else %} <i>unknown</i> {% endif %}
                    </div>
                </div>
                <div>
                    <table>
                        <tr>
                            <th valign="top" style="width: 250px">Indicator</th>
                            {% for scenario in scenarios %}
                                <th class="scenario scenario-{{ scenario.level }}" valign="top">
                                    Scenario {{ scenario.level }}
                                    <div>
                                        {{ scenario.name }}
                                    </div>
                                </th>
                            {% endfor %}
                        </tr>
                        {% for indicator in indicators %}
                            <tr class="indicator-row {% if indicator.show_in_context_analysis %}context-analysis{% endif %}">
                                <td>
                                    <a href="{% url "indicator-mapview" instance.slug indicator.id %}">{{ indicator.name }}</a>
                                </td>
                                {% for scenario in scenarios %}
                                    {% if indicator.scenario_value == scenario.level %}
                                        <td class="scenario indicator scenario-{{ scenario.level }}">
                                            {{ indicator.value }}
                                        </td>
                                    {% else %}
                                        <td class="scenario indicator">
                                            {% get_scenario_rule indicator scenario.level as rule %}
                                            {{ rule }}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </table>
                    {% if user.is_staff %}
                        <button id="toggle-table" class="main-button content-button scenario-{{ overall_scenario.level }}">Show all indicators</button>
                    {% endif %}
                </div>
            </div>
            <div id="map-wrapper"  class="section box-shadow-bottom ">
                <div id="map"></div>
                <div id="legend" class="box-shadow-bottom"></div>
            </div>
        </div>
        {% for intervention in interventions %}
            <div data-program="{{ intervention.program_instance.program.slug }}" class="section box-shadow-bottom table-section scenario-section">
                <div class="scenario-header scenario-{{ overall_scenario.level }}">
                    <div>{{ intervention.program_instance.program.name }} Intervention</div>
                </div>
                <div class="intervention">
                    <iframe src="{{ intervention.intervention_url }}" title="{{ intervention.program_instance.program.name }}" frameBorder="0"></iframe>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}
{% block scripts %}
    <script type="text/javascript" src="{% static 'libs/leaflet/1.5.1/leaflet.js' %}"></script>
    <script type="text/javascript" src="{% static 'libs/esri-leaflet/esri-leaflet.js' %}"></script>
    <script type="text/javascript" src="{% static 'libs/esri-leaflet/esri-leaflet-vector.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dashboard/context-analysis/map.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dashboard/context-analysis/esri/leaflet-esri-layer.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/dashboard/context-analysis/esri/leaflet-esri-style.js' %}"></script>
    <script>
        {# toogle the table#}
        $('#toggle-table').click(function () {
            $(this).toggleClass('all');
            if ($(this).hasClass('all')) {
                $(this).html('Show just context analysis indicators');
                $('.indicator-row').show();
            } else {
                $(this).html('Show all indicators');
                $('.indicator-row').hide();
                $('.context-analysis').show();
            }
        });
        const $list = $('.context-analysis-nav');
        $list.click(function () {
            $list.removeClass('active');
            $(this).addClass('active');
            $('.scenario-section').hide();

            const target = $(this).data('target');
            $(`div[data-program="${target}"]`).show();
            $('#content').scrollTop(0);
        });

        {# check hash #}
        if (!window.location.hash) {
            $($list[0]).click();
        } else {
            const hash = window.location.hash.replaceAll('#', '');
            const $target = $(`.context-analysis-nav[data-target="${hash}"]`);
            if ($target.length === 0) {
                $($list[0]).click();
            } else {
                $target.click();
            }

        }
    </script>
{% endblock %}